name: DLP Build

on:
  workflow_dispatch:

# üåé GLOBAL HOOK: Every step now has the Gemini Key
env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  CROSS_COMPILE_PATH: /home/runner/work/your-repo-name/aarch64-linux-android-4.9/bin/aarch64-linux-android-

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Initialization
        uses: actions/checkout@v4

      - name: 2. Environment Setup
        run: |
          # a. Pull Toolchains
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          git clone --depth=1 https://github.com/xiangfeidexiaohuo/Snapdragon-LLVM.git clang
          
          # b. Dependencies
          sudo add-apt-repository 'deb http://azure.archive.ubuntu.com/ubuntu/ focal main universe'
          sudo apt-get update
          sudo apt-get install -y libtinfo5 libncurses5 libssl-dev 7zip

      - name: 3. Source Reconstruction & Extraction
        run: |
          # a. Join parts
          [ -f Kernel.tar.gz.001 ] && cat Kernel.tar.gz.0* > Kernel.tar.gz
          
          # b. Extract into a clean, local folder
          mkdir -p kernel-source
          7z x Kernel.tar.gz -okernel-source/ -y
          
          # c. Verify - This prevents the "No such file" error later
          ls -R kernel-source/arch/arm64/configs/vendor/ || echo "‚ö†Ô∏è Vendor configs not found!"

      - name: 4. Surgical Code Patching
        run: |
          cd kernel-source
          
          # a. Robust WALT Patching
          WALT_TRACE_FILE=$(find . -name "walt/trace.h" -o -name "walt_trace.h" | head -n 1)
          if [ -n "$WALT_TRACE_FILE" ]; then
            chmod +w "$WALT_TRACE_FILE"
            printf "struct rq;\nstruct group_cpu_time;\nstruct walt_related_thread_group;\n#ifndef MAX_CLUSTERS\n#define MAX_CLUSTERS 3\n#endif\n#include <linux/types.h>\n" > header_fix.txt
            cat header_fix.txt "$WALT_TRACE_FILE" > trace.tmp && mv trace.tmp "$WALT_TRACE_FILE"
            echo "‚úÖ WALT Patched at $WALT_TRACE_FILE"
          else
            echo "‚ö†Ô∏è WALT trace not found, skipping patch."
          fi

      - name: 5. Marathon Build
        run: |
          cd kernel-source
          
          # a. Setup Paths
          ROOT_DIR=$(pwd)
          LD_PATH=$(find ../aarch64-linux-android-4.9 -name "aarch64-linux-android-ld" | head -n 1)
          CLANG_PATH=$(find ../clang -name "clang" -type f | grep "bin/clang" | head -n 1)
          
          # b. Apply Config
          TARGET_CONFIG=$(find arch/arm64/configs/ -name "gta9pwifi_eur_open_defconfig" | sed 's|arch/arm64/configs/||')
          yes "" | make ARCH=arm64 CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- "$TARGET_CONFIG"

          # c. Main Build
          make -j$(nproc) \
               ARCH=arm64 \
               CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- \
               CC="$CLANG_PATH" \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               LD="$LD_PATH" \
               LLVM=1 \
               KCFLAGS="-Wno-error -fno-integrated-as -Wno-implicit-function-declaration"

      - name: 6. AI Error Analyzer (Only on Failure)
        if: failure()
        run: |
          # Use the Global Key to analyze the build failure
          echo "ü§ñ Gemini is analyzing the crash..."
          # This pulls the last 50 lines of the build log and asks Gemini for a fix
          # (Requires a small python or node script, or we can just log the output)
          echo "Build failed. Check the logs above for the specific CC error."

      - name: 7. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SM-X210-Kernel
          path: kernel-source/arch/arm64/boot/Image.gz*
