name: DLP Build

on:
  workflow_dispatch:

# ðŸŒŽ GLOBAL HOOK: Every step now has the Gemini Key
env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Initialization
        uses: actions/checkout@v4

      - name: 2. Environment Setup & Space Guard
        run: |
          # ðŸ›°ï¸ Space Guard: Check 'Juice' levels
          echo "ðŸ“Š Available Disk Space Before Setup:"
          df -h | grep "/home"

          # a. Pull Toolchains & STRIP 'DEBT' (Delete .git to save space)
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          rm -rf aarch64-linux-android-4.9/.git
          
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          rm -rf arm-linux-androideabi-4.9/.git
          
          git clone --depth=1 https://github.com/xiangfeidexiaohuo/Snapdragon-LLVM.git clang
          rm -rf clang/.git
          
          # b. The Precision Join
          if ls Kernel.tar.gz.* 1> /dev/null 2>&1; then
            cat Kernel.tar.gz.* > Full_Kernel.zip
            rm Kernel.tar.gz.* # ðŸ—‘ï¸ Clean up split parts immediately to save space
          else
            [ -f Kernel.tar.gz ] && mv Kernel.tar.gz Full_Kernel.zip
          fi

          # c. Extraction
          mkdir -p kernel-source
          7z x Full_Kernel.zip -okernel-source/ -y -mmt=on > /dev/null
          rm Full_Kernel.zip # ðŸ—‘ï¸ More space for the 'Juicy' stuff
          
          # d. Flattening (The 'Wowza' move)
          REAL_SRC=$(find kernel-source/ -name "arch" -type d -print -quit | xargs dirname)
          if [ -n "$REAL_SRC" ] && [ "$REAL_SRC" != "kernel-source" ]; then
            mv "$REAL_SRC"/* kernel-source/ 2>/dev/null || true
          fi

          echo "ðŸ“Š Available Disk Space After Setup:"
          df -h | grep "/home"

      - name: 3. Visibility Check & Permission Grant
        run: |
          cd kernel-source
          echo "ðŸ“ Current Location: $(pwd)"
          if [ -d "arch" ]; then
            echo "âœ… WOWZA! Arch folder found and visible."
            chmod -R 777 . # Give the 'wrists' full control
            ls -F
          else
            echo "âŒ Still hidden. Listing Step 2 output:"
            ls -R .. | head -n 50
            exit 1
          fi

          # 3. ðŸ—ï¸ Structural Leveling
          # Get the folder containing the Makefile
          SRC_DIR=$(dirname "$REAL_PATH")
          echo "ðŸŽ¯ Heart found at: $SRC_DIR"
          
          # Move everything from the 'Heart' to the 'kernel-source' root
          mv "$SRC_DIR"/* kernel-source/ 2>/dev/null || true
          cd kernel-source
          
          echo "âœ… Visibility Check (Should see arch/):"
          ls -F

      - name: 4. Surgical Code Patching
        run: |
          cd kernel-source
          WALT_TRACE_FILE=$(find . -name "trace.h" | grep "walt" | head -n 1)
          if [ -n "$WALT_TRACE_FILE" ]; then
            chmod +w "$WALT_TRACE_FILE"
            printf "struct rq;\nstruct group_cpu_time;\nstruct walt_related_thread_group;\n#ifndef MAX_CLUSTERS\n#define MAX_CLUSTERS 3\n#endif\n#include <linux/types.h>\n" > header_fix.txt
            cat header_fix.txt "$WALT_TRACE_FILE" > trace.tmp && mv trace.tmp "$WALT_TRACE_FILE"
            echo "âœ… WALT Patched at $WALT_TRACE_FILE"
          else
            echo "âš ï¸ WALT trace not found, skipping patch."
          fi

      - name: 5. Marathon Build
        run: |
          cd kernel-source
          # Search for the config file everywhere in the current directory
          REAL_CONFIG_PATH=$(find . -name "gta9pwifi_eur_open_defconfig" | head -n 1)
          # Strip the leading ./ and arch/arm64/configs/ to make it 'vendor/...'
          FINAL_CONFIG=$(echo "$REAL_CONFIG_PATH" | sed 's|.*/configs/||')
          
          echo "ðŸš€ Found config at: $FINAL_CONFIG"
          yes "" | make ARCH=arm64 CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- "$FINAL_CONFIG"

          LD_PATH=$(find ../aarch64-linux-android-4.9 -name "aarch64-linux-android-ld" | head -n 1)
          CLANG_PATH=$(find ../clang -name "clang" -type f | grep "bin/clang" | head -n 1)
          
          # Use find to get the exact relative path for the vendor config
          TARGET_CONFIG=$(find arch/arm64/configs/ -name "gta9pwifi_eur_open_defconfig" | sed 's|arch/arm64/configs/||')
          
          yes "" | make ARCH=arm64 CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- "$TARGET_CONFIG"

          # Run make and log output for the AI to analyze if it fails
          make -j$(nproc) \
               ARCH=arm64 \
               CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- \
               CC="$CLANG_PATH" \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               LD="$LD_PATH" \
               LLVM=1 \
               KCFLAGS="-Wno-error -fno-integrated-as -Wno-implicit-function-declaration" 2>&1 | tee build_output.log

      - name: 6. ðŸ¤– AI Error Analyzer (Only on Failure)
        if: failure()
        run: |
          echo "ðŸ¤– Sending crash logs to Gemini for surgical analysis..."
          # Grab last 50 lines of the build log
          ERROR_LOG=$(tail -n 50 kernel-source/build_output.log)
          
          # Use npx to call Gemini directly from the shell
          npx @google/gemini-cli "I am building a kernel for SM-X210. The build failed with this error: $ERROR_LOG. Please provide a specific terminal command or code fix to solve this."

      - name: 7. Final Package & Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SM-X210-Result
          path: |
            kernel-source/arch/arm64/boot/Image.gz*
            kernel-source/build_output.log
               CROSS_COMPILE=../aarch64-linux-android-4.9/bin/aarch64-linux-android- \
               CC="$CLANG_PATH" \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               LD="$LD_PATH" \
               LLVM=1 \
               KCFLAGS="-Wno-error -fno-integrated-as -Wno-implicit-function-declaration"
