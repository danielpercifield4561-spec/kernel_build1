name: DLP

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        run: |
          # Use = for everything to match your config.env
          echo "ANYKERNEL_SOURCE=$(grep -w "ANYKERNEL_SOURCE" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV
          echo "ANYKERNEL_SOURCE_BRANCH=$(grep -w "ANYKERNEL_SOURCE_BRANCH" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV
          echo "KERNEL_SOURCE=$(grep -w "KERNEL_SOURCE" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV
          echo "KERNEL_SOURCE_BRANCH=$(grep -w "KERNEL_SOURCE_BRANCH" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV
          echo "KERNEL_CONFIG=$(grep -w "KERNEL_CONFIG" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV
          echo "BUILD_ARGS=$(grep -w "BUILD_ARGS" config.env | cut -d "=" -f 2 | tr -d '\r' | tr -d '[:space:]')" >> $GITHUB_ENV

   
      - name: Pull toolchain
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          git clone https://github.com/xiangfeidexiaohuo/Snapdragon-LLVM.git clang
          
      - name: Pull kernel source
        run: |
          git clone --depth=1 ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} kernel-source

      - name: Install Legacy Dependencies
        run: |
          # Add the Ubuntu 20.04 (Focal) repository for legacy libs
          sudo add-apt-repository 'deb http://azure.archive.ubuntu.com/ubuntu/ focal main universe'
          sudo apt-get update
          
          # Install the specific versions needed by older Clang
          sudo apt-get install -y libtinfo5 libncurses5 libssl-dev

      - name: Package kernel
        run: |
         # 1. Get AnyKernel3 template if it's not already there
         if [ ! -d "AnyKernel3" ]; then
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel3
         fi

         # 2. Create a fresh output workspace
         rm -rf out && mkdir -p out
         cp -r AnyKernel3/* out/
        
         # 3. Use find to grab the compiled images from the build directory
         # This ignores "No such file" errors and finds them wherever they landed
         find kernel-source/arch/arm64/boot/ -name "Image" -exec cp {} out/ \; 2>/dev/null || true
         find kernel-source/arch/arm64/boot/ -name "Image.gz" -exec cp {} out/ \; 2>/dev/null || true
         find kernel-source/arch/arm64/boot/ -name "dtbo.img" -exec cp {} out/ \; 2>/dev/null || true

      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
         name: Flashable_Kernel_Zip
         path: out/*
